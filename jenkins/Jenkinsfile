pipeline {
    agent any
    
    environment {
        // ============================================
        // NOMBRES DE CONTENEDORES (para docker exec)
        // ============================================
        // NOTA: Estos son los nombres de los CONTENEDORES Docker
        //       Se usan con comandos como: docker exec ${CONTAINER_NAME}
        MYSQL_CONTAINER = "laravel_mysql"
        NGINX_CONTAINER = "laravel_nginx"
        FRONTEND_CONTAINER = "nextjs_frontend"
        GITEA_CONTAINER = "gitea_server"
        JENKINS_CONTAINER = "jenkins_server"
        LARAVEL_CONTAINER = "laravel_backend"
        
        // ============================================
        // NOMBRES DE SERVICIOS (para comunicaci√≥n HTTP entre contenedores)
        // ============================================
        // NOTA: Estos son los nombres de los SERVICIOS en docker-compose.yml
        //       Se usan para comunicaci√≥n HTTP dentro de la red Docker
        //       Ejemplo: curl http://gitea:3000/api/v1/version
        MYSQL_SERVICE = "mysql"
        NGINX_SERVICE = "nginx"
        FRONTEND_SERVICE = "frontend"
        GITEA_SERVICE = "gitea"
        JENKINS_SERVICE = "jenkins"
        
        // ============================================
        // PUERTOS Y CONFIGURACI√ìN
        // ============================================
        MYSQL_PORT = "3306"
        NGINX_PORT = "80"
        FRONTEND_PORT = "3000"
        GITEA_PORT = "3000"
        JENKINS_PORT = "8080"
        
        // ============================================
        // CONFIGURACI√ìN DE GITEA
        // ============================================
        GITEA_REPO_NAME = "poli_integracion_continua"
        GITEA_REPO_OWNER = "admin"
        
        // ============================================
        // TIMEOUTS
        // ============================================
        CONNECTION_TIMEOUT = "10"
        HTTP_TIMEOUT = "30"
    }
    
    stages {
        stage('Verificar Conexiones a Contenedores') {
            steps {
                script {
                    echo ""
                    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
                    echo "‚ïë  üîç VERIFICACI√ìN DE CONECTIVIDAD DE CONTENEDORES             ‚ïë"
                    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
                    echo ""
                    
                    def containers = [
                        [name: 'MySQL', container: env.MYSQL_CONTAINER, service: env.MYSQL_SERVICE, port: env.MYSQL_PORT, type: 'tcp'],
                        [name: 'Nginx', container: env.NGINX_CONTAINER, service: env.NGINX_SERVICE, port: env.NGINX_PORT, type: 'http'],
                        [name: 'Laravel Backend', container: env.LARAVEL_CONTAINER, service: 'backend', port: 'N/A', type: 'container'],
                        [name: 'Next.js Frontend', container: env.FRONTEND_CONTAINER, service: env.FRONTEND_SERVICE, port: env.FRONTEND_PORT, type: 'http'],
                        [name: 'Gitea', container: env.GITEA_CONTAINER, service: env.GITEA_SERVICE, port: env.GITEA_PORT, type: 'http'],
                        [name: 'Jenkins', container: env.JENKINS_CONTAINER, service: env.JENKINS_SERVICE, port: env.JENKINS_PORT, type: 'http']
                    ]
                    
                    def results = []
                    def failedServices = []
                    
                    containers.eachWithIndex { container, index ->
                        echo "[${index + 1}/${containers.size()}] Verificando ${container.name}..."
                        echo "   Contenedor: ${container.container}:${container.port}"
                        
                        // Verificar que el contenedor est√° corriendo
                        def containerRunning = sh(
                            script: """
                                sudo docker ps --format '{{.Names}}' | grep -q '^${container.container}\$' && echo "OK" || echo "FAIL"
                            """,
                            returnStdout: true
                        ).trim()
                        
                        if (containerRunning != 'OK') {
                            echo "   ‚ùå Contenedor no est√° corriendo"
                            results.add([name: container.name, status: '‚ùå FALLO'])
                            failedServices.add(container.name)
                        } else {
                            echo "   ‚úÖ Contenedor activo"
                            
                            // Verificar conectividad seg√∫n el tipo
                            if (container.type == 'tcp') {
                                def tcpResult = sh(
                                    script: """
                                        timeout ${env.CONNECTION_TIMEOUT} bash -c '</dev/tcp/${container.container}/${container.port}' 2>/dev/null && echo "OK" || echo "FAIL"
                                    """,
                                    returnStdout: true
                                ).trim()
                                
                                if (tcpResult == 'OK') {
                                    echo "   ‚úÖ Puerto ${container.port} accesible"
                                    results.add([name: container.name, status: '‚úÖ OK'])
                                } else {
                                    echo "   ‚ùå Puerto ${container.port} no accesible"
                                    results.add([name: container.name, status: '‚ùå FALLO'])
                                    failedServices.add(container.name)
                                }
                                
                            } else if (container.type == 'http') {
                                // Para comunicaci√≥n HTTP, usar el nombre del SERVICIO (no el contenedor)
                                def endpoint = "http://${container.service}:${container.port}"
                                if (container.service == env.JENKINS_SERVICE) {
                                    endpoint = "${endpoint}/login"
                                } else if (container.service == env.GITEA_SERVICE) {
                                    endpoint = "${endpoint}/api/v1/version"
                                }
                                
                                def httpCode = sh(
                                    script: """
                                        HTTP_CODE=\$(curl -s -o /dev/null -w "%{http_code}" --max-time ${env.HTTP_TIMEOUT} ${endpoint} 2>/dev/null || echo "000")
                                        echo \$(echo "\$HTTP_CODE" | tr -d '[:space:]' | grep -oE '[0-9]{3}' | head -1 || echo "000")
                                    """,
                                    returnStdout: true
                                ).trim()
                                
                                if (httpCode in ['200', '301', '302', '401', '403', '404']) {
                                    echo "   ‚úÖ Respuesta HTTP: ${httpCode}"
                                    results.add([name: container.name, status: '‚úÖ OK'])
                                } else {
                                    echo "   ‚ùå Sin respuesta HTTP (c√≥digo: ${httpCode})"
                                    results.add([name: container.name, status: '‚ùå FALLO'])
                                    failedServices.add(container.name)
                                }
                                
                            } else if (container.type == 'container') {
                                // Solo contenedor activo, sin verificaci√≥n de puerto
                                results.add([name: container.name, status: '‚úÖ OK'])
                            }
                        }
                        echo ""
                    }
                    
                    // Mostrar resumen
                    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                    echo "üìä RESUMEN"
                    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                    echo ""
                    echo "‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê"
                    echo "‚îÇ Servicio                     ‚îÇ Estado               ‚îÇ"
                    echo "‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§"
                    
                    results.each { result ->
                        def name = result.name.padRight(28)
                        def status = result.status.padRight(20)
                        echo "‚îÇ ${name} ‚îÇ ${status} ‚îÇ"
                    }
                    
                    echo "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò"
                    echo ""
                    
                    def successCount = results.count { it.status == '‚úÖ OK' }
                    echo "‚úÖ Exitosos: ${successCount}/${results.size()}"
                    
                    if (failedServices.size() > 0) {
                        echo "‚ùå Fallidos: ${failedServices.join(', ')}"
                        error("Verificaci√≥n fall√≥: ${failedServices.size()} servicio(s) no est√°n accesibles")
                    } else {
                        echo "‚úÖ Todos los contenedores est√°n accesibles"
                    }
                    echo ""
                }
            }
        }
        
        stage('Verificar Integraci√≥n Jenkins-Gitea') {
            steps {
                script {
                    echo ""
                    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
                    echo "‚ïë  üîó VERIFICACI√ìN JENKINS-GITEA                                ‚ïë"
                    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
                    echo ""
                    
                    def checks = [:]
                    
                    // 1. Plugin de Gitea
                    echo "1. Verificando plugin de Gitea..."
                    // NOTA: docker exec usa el nombre del CONTENEDOR
                    def pluginInstalled = sh(
                        script: """
                            sudo docker exec ${env.JENKINS_CONTAINER} ls /var/jenkins_home/plugins/ 2>/dev/null | grep -i gitea > /dev/null && echo "OK" || echo "FAIL"
                        """,
                        returnStdout: true
                    ).trim()
                    checks['Plugin'] = pluginInstalled == 'OK'
                    echo "   ${pluginInstalled == 'OK' ? '‚úÖ Plugin instalado' : '‚ö†Ô∏è  Plugin no encontrado'}"
                    echo ""
                    
                    // 2. Conectividad Jenkins ‚Üí Gitea
                    echo "2. Verificando conectividad Jenkins ‚Üí Gitea..."
                    // NOTA: docker exec usa CONTENEDOR, pero curl dentro usa SERVICIO
                    def connectivity = sh(
                        script: """
                            HTTP_CODE=\$(sudo docker exec ${env.JENKINS_CONTAINER} curl -s -o /dev/null -w "%{http_code}" --max-time ${env.HTTP_TIMEOUT} http://${env.GITEA_SERVICE}:${env.GITEA_PORT}/api/v1/version 2>/dev/null || echo "000")
                            echo \$(echo "\$HTTP_CODE" | tr -d '[:space:]' | grep -oE '[0-9]{3}' | head -1 || echo "000")
                        """,
                        returnStdout: true
                    ).trim()
                    checks['Conectividad'] = connectivity == '200'
                    echo "   ${connectivity == '200' ? '‚úÖ Conexi√≥n exitosa (HTTP 200)' : '‚ùå Sin conexi√≥n (HTTP ' + connectivity + ')'}"
                    echo ""
                    
                    // 3. Acceso al repositorio
                    echo "3. Verificando acceso al repositorio..."
                    // NOTA: docker exec usa CONTENEDOR, pero curl dentro usa SERVICIO
                    def repoAccess = sh(
                        script: """
                            HTTP_CODE=\$(sudo docker exec ${env.JENKINS_CONTAINER} curl -s -o /dev/null -w "%{http_code}" -u jenkins:\${GITEA_PASSWORD:-jenkins123} --max-time ${env.HTTP_TIMEOUT} "http://${env.GITEA_SERVICE}:${env.GITEA_PORT}/api/v1/repos/${env.GITEA_REPO_OWNER}/${env.GITEA_REPO_NAME}" 2>/dev/null || echo "000")
                            echo \$(echo "\$HTTP_CODE" | tr -d '[:space:]' | grep -oE '[0-9]{3}' | head -1 || echo "000")
                        """,
                        returnStdout: true
                    ).trim()
                    checks['Repositorio'] = repoAccess == '200'
                    
                    if (repoAccess == '200') {
                        echo "   ‚úÖ Acceso al repositorio exitoso"
                    } else if (repoAccess in ['401', '403']) {
                        echo "   ‚ö†Ô∏è  Acceso denegado (verifica credenciales)"
                    } else if (repoAccess == '404') {
                        echo "   ‚ö†Ô∏è  Repositorio no encontrado"
                    } else {
                        echo "   ‚ö†Ô∏è  Sin respuesta (HTTP ${repoAccess})"
                    }
                    echo ""
                    
                    // Resumen
                    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                    def allOk = checks.values().every { it == true }
                    if (allOk) {
                        echo "‚úÖ Integraci√≥n Jenkins-Gitea: OK"
                    } else {
                        echo "‚ö†Ô∏è  Integraci√≥n Jenkins-Gitea: Requiere atenci√≥n"
                        def failed = checks.findAll { !it.value }.keySet()
                        echo "   Items a verificar: ${failed.join(', ')}"
                    }
                    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                    echo ""
                }
            }
        }
        
        stage('Verificar Configuraci√≥n del Plugin Gitea') {
            steps {
                script {
                    echo ""
                    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
                    echo "‚ïë  üîå VERIFICACI√ìN DEL PLUGIN DE GITEA                          ‚ïë"
                    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
                    echo ""
                    
                    def pluginStatus = [:]
                    
                    // 1. Verificar instalaci√≥n del plugin (archivo f√≠sico)
                    echo "1. Verificando instalaci√≥n del plugin..."
                    def pluginFile = sh(
                        script: """
                            sudo docker exec ${env.JENKINS_CONTAINER} ls /var/jenkins_home/plugins/ 2>/dev/null | grep -iE 'gitea.*\\.jpi|gitea.*\\.hpi' | head -1 || echo ""
                        """,
                        returnStdout: true
                    ).trim()
                    
                    if (pluginFile) {
                        pluginStatus['instalado'] = true
                        echo "   ‚úÖ Plugin instalado: ${pluginFile}"
                    } else {
                        pluginStatus['instalado'] = false
                        echo "   ‚ùå Plugin no encontrado en el sistema de archivos"
                    }
                    echo ""
                    
                    // 2. Verificar si las clases del plugin est√°n disponibles
                    echo "2. Verificando disponibilidad de clases del plugin..."
                    def classesAvailable = [:]
                    
                    // Intentar cargar diferentes clases del plugin
                    def classesToCheck = [
                        'GiteaSCMSource': 'org.jenkinsci.plugin.gitea.GiteaSCMSource',
                        'GiteaServers': 'org.jenkinsci.plugin.gitea.servers.GiteaServers',
                        'GiteaNotifier': 'org.jenkinsci.plugin.gitea.GiteaNotifier'
                    ]
                    
                    classesToCheck.each { name, className ->
                        try {
                            Class.forName(className)
                            classesAvailable[name] = true
                            echo "   ‚úÖ Clase ${name} disponible"
                        } catch (ClassNotFoundException e) {
                            classesAvailable[name] = false
                            echo "   ‚ö†Ô∏è  Clase ${name} no disponible (${e.getMessage()})"
                        }
                    }
                    
                    pluginStatus['clases'] = classesAvailable
                    echo ""
                    
                    // 3. Verificar servidor Gitea configurado
                    echo "3. Verificando configuraci√≥n del servidor Gitea..."
                    def serverConfigured = false
                    def manageHooksEnabled = false
                    
                    try {
                        def giteaServers = org.jenkinsci.plugin.gitea.servers.GiteaServers.get()
                        def servers = giteaServers.getServers()
                        
                        if (servers && servers.size() > 0) {
                            serverConfigured = true
                            echo "   ‚úÖ Servidor(es) Gitea configurado(s):"
                            servers.each { server ->
                                def serverUrl = server.getServerUrl()
                                def credentialsId = server.getCredentialsId()
                                // NOTA: El m√©todo correcto es isManageHooks(), no getManageHooks()
                                def manageHooks = server.isManageHooks()
                                
                                echo "      - ${server.getDisplayName()}: ${serverUrl}"
                                echo "        Credenciales: ${credentialsId}"
                                echo "        Gestionar Webhooks: ${manageHooks ? '‚úÖ Habilitado' : '‚ùå Deshabilitado'}"
                                
                                if (manageHooks) {
                                    manageHooksEnabled = true
                                }
                                
                                // Verificar si el servidor coincide con nuestra configuraci√≥n
                                def expectedUrl = "http://${env.GITEA_SERVICE}:${env.GITEA_PORT}"
                                if (serverUrl == expectedUrl || serverUrl.contains(env.GITEA_SERVICE)) {
                                    echo "        ‚úÖ URL coincide con la configuraci√≥n esperada"
                                } else {
                                    echo "        ‚ö†Ô∏è  URL no coincide con la esperada (${expectedUrl})"
                                }
                            }
                        } else {
                            echo "   ‚ùå No hay servidores Gitea configurados en el plugin"
                        }
                    } catch (Exception e) {
                        echo "   ‚ö†Ô∏è  No se pudo acceder a la configuraci√≥n del plugin: ${e.getMessage()}"
                        echo "      Esto puede indicar que el plugin no est√° completamente cargado"
                    }
                    
                    pluginStatus['servidor_configurado'] = serverConfigured
                    pluginStatus['webhooks_habilitados'] = manageHooksEnabled
                    echo ""
                    
                    // 4. Resumen y recomendaciones
                    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                    echo "üìä RESUMEN DEL PLUGIN DE GITEA"
                    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                    echo ""
                    
                    if (pluginStatus['instalado'] && pluginStatus['servidor_configurado']) {
                        echo "‚úÖ Plugin de Gitea: INSTALADO Y CONFIGURADO"
                        echo ""
                        echo "‚ÑπÔ∏è  Estado actual:"
                        echo "   - Plugin instalado: ‚úÖ"
                        echo "   - Servidor configurado: ‚úÖ"
                        echo "   - Webhooks autom√°ticos: ${manageHooksEnabled ? '‚úÖ Habilitado' : '‚ö†Ô∏è  Deshabilitado'}"
                        echo ""
                        
                        if (classesAvailable['GiteaSCMSource']) {
                            echo "‚úÖ Clases del plugin disponibles para uso completo"
                        } else {
                            echo "‚ö†Ô∏è  Clases del plugin no disponibles a√∫n (puede requerir reinicio de Jenkins)"
                        }
                        echo ""
                        echo "üí° Para usar completamente el plugin de Gitea con webhooks y eventos:"
                        echo "   1. Aseg√∫rate de que 'Gestionar Webhooks' est√© habilitado en la configuraci√≥n"
                        echo "   2. Para pipelines simples: El plugin gestionar√° webhooks autom√°ticamente"
                        echo "   3. Para funcionalidades completas: Considera usar Multibranch Pipeline con GiteaSCMSource"
                    } else {
                        echo "‚ö†Ô∏è  Plugin de Gitea: REQUIERE ATENCI√ìN"
                        if (!pluginStatus['instalado']) {
                            echo "   - Plugin no encontrado en el sistema"
                        }
                        if (!pluginStatus['servidor_configurado']) {
                            echo "   - Servidor Gitea no configurado"
                        }
                        echo ""
                        echo "üí° Acciones recomendadas:"
                        echo "   1. Verificar que el plugin est√© instalado: gitea:latest"
                        echo "   2. Configurar el servidor Gitea en Jenkins (Manage Jenkins > Configure System)"
                        echo "   3. Habilitar 'Gestionar Webhooks' para integraci√≥n autom√°tica"
                    }
                    echo ""
                    
                    // Guardar estado para uso posterior
                    env.GITEA_PLUGIN_INSTALLED = pluginStatus['instalado'] ? 'true' : 'false'
                    env.GITEA_PLUGIN_CONFIGURED = pluginStatus['servidor_configurado'] ? 'true' : 'false'
                    env.GITEA_WEBHOOKS_ENABLED = manageHooksEnabled ? 'true' : 'false'
                }
            }
        }
        
        stage('Checkout desde Gitea') {
            steps {
                script {
                    echo ""
                    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
                    echo "‚ïë  üì• CHECKOUT DESDE GITEA                                      ‚ïë"
                    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
                    echo ""
                    
                    // URL del repositorio en Gitea usando el servidor configurado
                    // NOTA: Para checkout desde Jenkins, usar el nombre del SERVICIO (comunicaci√≥n HTTP)
                    def giteaServerUrl = "http://${env.GITEA_SERVICE}:${env.GITEA_PORT}"
                    def repoUrl = "${giteaServerUrl}/${env.GITEA_REPO_OWNER}/${env.GITEA_REPO_NAME}.git"
                    
                    echo "üì¶ Repositorio: ${repoUrl}"
                    echo "üîë Usando credenciales: gitea-credentials"
                    echo "üåê Servidor Gitea configurado: ${giteaServerUrl}"
                    echo ""
                    
                    // Mostrar estado del plugin de Gitea
                    def pluginInstalled = env.GITEA_PLUGIN_INSTALLED == 'true'
                    def pluginConfigured = env.GITEA_PLUGIN_CONFIGURED == 'true'
                    def webhooksEnabled = env.GITEA_WEBHOOKS_ENABLED == 'true'
                    
                    echo "üîå Estado del Plugin de Gitea:"
                    echo "   - Plugin instalado: ${pluginInstalled ? '‚úÖ' : '‚ùå'}"
                    echo "   - Servidor configurado: ${pluginConfigured ? '‚úÖ' : '‚ùå'}"
                    echo "   - Webhooks autom√°ticos: ${webhooksEnabled ? '‚úÖ Habilitado' : '‚ö†Ô∏è  Deshabilitado'}"
                    echo ""
                    
                    // NOTA: Para pipelines declarativos simples, el plugin de Gitea usa GitSCM internamente
                    // pero con integraci√≥n espec√≠fica de Gitea (webhooks, notificaciones, etc.)
                    // El plugin de Gitea est√° dise√±ado principalmente para multibranch pipelines
                    // con GiteaSCMSource, pero tambi√©n funciona con GitSCM para pipelines simples
                    
                    if (pluginConfigured && webhooksEnabled) {
                        echo "‚úÖ Usando GitSCM con integraci√≥n del plugin de Gitea"
                        echo "   - El plugin de Gitea gestionar√° webhooks autom√°ticamente"
                        echo "   - Las credenciales se validan contra el servidor Gitea configurado"
                        echo "   - Las notificaciones se enviar√°n a Gitea al finalizar el build"
                        echo "   - Los eventos de Gitea (push, PR, etc.) activar√°n el pipeline"
                    } else if (pluginConfigured) {
                        echo "‚ö†Ô∏è  Usando GitSCM con plugin de Gitea (webhooks deshabilitados)"
                        echo "   - Las credenciales se validan contra el servidor Gitea configurado"
                        echo "   - Webhooks NO se gestionar√°n autom√°ticamente"
                        echo "   - Considera habilitar 'Gestionar Webhooks' en la configuraci√≥n del plugin"
                    } else {
                        echo "‚ö†Ô∏è  Usando GitSCM gen√©rico (plugin de Gitea no configurado)"
                        echo "   - Funcionalidad b√°sica de Git disponible"
                        echo "   - Webhooks y eventos de Gitea NO estar√°n disponibles"
                        echo "   - Configura el servidor Gitea en Jenkins para habilitar funcionalidades completas"
                    }
                    echo ""
                    
                    // Intentar checkout con diferentes ramas
                    def branches = ['*/main', '*/master', '*/develop']
                    def checkoutSuccess = false
                    def lastError = null
                    
                    for (def branch : branches) {
                        try {
                            echo "üîÑ Intentando checkout de rama: ${branch}"
                            checkout([
                                $class: 'GitSCM',
                                branches: [[name: branch]],
                                doGenerateSubmoduleConfigurations: false,
                                extensions: [],
                                submoduleCfg: [],
                                userRemoteConfigs: [[
                                    credentialsId: 'gitea-credentials',
                                    url: repoUrl
                                ]]
                            ])
                            checkoutSuccess = true
                            echo "‚úÖ Checkout exitoso de rama: ${branch}"
                            break
                        } catch (Exception e) {
                            lastError = e.getMessage()
                            echo "‚ö†Ô∏è  No se pudo hacer checkout de ${branch}: ${e.getMessage()}"
                            continue
                        }
                    }
                    
                    if (!checkoutSuccess) {
                        error("No se pudo hacer checkout de ninguna rama. √öltimo error: ${lastError}")
                    }
                    
                    // Verificar que el checkout fue exitoso y que el remoto apunta a Gitea
                    def currentBranch = sh(
                        script: 'git rev-parse --abbrev-ref HEAD',
                        returnStdout: true
                    ).trim()
                    
                    def remoteUrl = sh(
                        script: 'git config --get remote.origin.url',
                        returnStdout: true
                    ).trim()
                    
                    // Validar que el remoto es del servidor Gitea configurado
                    // NOTA: El remoto puede contener el nombre del servicio o del contenedor
                    if (remoteUrl.contains(env.GITEA_SERVICE) || remoteUrl.contains(env.GITEA_CONTAINER)) {
                        echo "‚úÖ Verificaci√≥n: Remoto apunta al servidor Gitea configurado"
                        echo "   ${remoteUrl}"
                    } else {
                        echo "‚ö†Ô∏è  Advertencia: El remoto no parece ser del servidor Gitea esperado"
                        echo "   Esperado: ${env.GITEA_SERVICE} o ${env.GITEA_CONTAINER}"
                        echo "   Obtenido: ${remoteUrl}"
                    }
                    
                    echo ""
                    echo "‚úÖ Checkout completado exitosamente"
                    echo "üìå Rama actual: ${currentBranch}"
                    echo "üîó Remoto: ${remoteUrl}"
                    echo ""
                }
            }
        }
        
        stage('Validar Informaci√≥n del √öltimo Commit') {
            steps {
                script {
                    echo ""
                    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
                    echo "‚ïë  üìã VALIDACI√ìN DEL √öLTIMO COMMIT                                ‚ïë"
                    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
                    echo ""
                    
                    // Obtener informaci√≥n del √∫ltimo commit
                    def commitHash = sh(
                        script: 'git rev-parse HEAD',
                        returnStdout: true
                    ).trim()
                    
                    def commitShortHash = sh(
                        script: 'git rev-parse --short HEAD',
                        returnStdout: true
                    ).trim()
                    
                    def commitAuthor = sh(
                        script: 'git log -1 --pretty=format:"%an"',
                        returnStdout: true
                    ).trim()
                    
                    def commitEmail = sh(
                        script: 'git log -1 --pretty=format:"%ae"',
                        returnStdout: true
                    ).trim()
                    
                    def commitDate = sh(
                        script: 'git log -1 --pretty=format:"%ad" --date=format:"%Y-%m-%d %H:%M:%S"',
                        returnStdout: true
                    ).trim()
                    
                    def commitMessage = sh(
                        script: 'git log -1 --pretty=format:"%s"',
                        returnStdout: true
                    ).trim()
                    
                    def commitBody = sh(
                        script: 'git log -1 --pretty=format:"%b"',
                        returnStdout: true
                    ).trim()
                    
                    def branchName = sh(
                        script: 'git rev-parse --abbrev-ref HEAD',
                        returnStdout: true
                    ).trim()
                    
                    def remoteUrl = sh(
                        script: 'git config --get remote.origin.url',
                        returnStdout: true
                    ).trim()
                    
                    // Mostrar informaci√≥n del commit
                    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                    echo "üìä INFORMACI√ìN DEL √öLTIMO COMMIT"
                    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                    echo ""
                    echo "‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê"
                    echo "‚îÇ Hash Completo: ${commitHash.padRight(47)} ‚îÇ"
                    echo "‚îÇ Hash Corto:    ${commitShortHash.padRight(47)} ‚îÇ"
                    echo "‚îÇ Rama:          ${branchName.padRight(47)} ‚îÇ"
                    echo "‚îÇ Autor:         ${commitAuthor.padRight(47)} ‚îÇ"
                    echo "‚îÇ Email:         ${commitEmail.padRight(47)} ‚îÇ"
                    echo "‚îÇ Fecha:         ${commitDate.padRight(47)} ‚îÇ"
                    echo "‚îÇ Repositorio:   ${remoteUrl.padRight(47)} ‚îÇ"
                    echo "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò"
                    echo ""
                    echo "üìù Mensaje del Commit:"
                    echo "   ${commitMessage}"
                    if (commitBody) {
                        echo ""
                        echo "üìÑ Cuerpo del Commit:"
                        commitBody.split('\n').each { line ->
                            echo "   ${line}"
                        }
                    }
                    echo ""
                    
                    // Validaciones
                    def validations = [:]
                    def validationErrors = []
                    
                    // Validar que el hash existe
                    if (commitHash && commitHash.length() == 40) {
                        validations['Hash v√°lido'] = true
                        echo "‚úÖ Hash del commit v√°lido (40 caracteres)"
                    } else {
                        validations['Hash v√°lido'] = false
                        validationErrors.add("Hash del commit inv√°lido: ${commitHash}")
                        echo "‚ùå Hash del commit inv√°lido"
                    }
                    
                    // Validar que hay autor
                    if (commitAuthor && commitAuthor.length() > 0) {
                        validations['Autor presente'] = true
                        echo "‚úÖ Autor del commit presente: ${commitAuthor}"
                    } else {
                        validations['Autor presente'] = false
                        validationErrors.add("Autor del commit no encontrado")
                        echo "‚ùå Autor del commit no encontrado"
                    }
                    
                    // Validar que hay email
                    if (commitEmail && commitEmail.contains('@')) {
                        validations['Email v√°lido'] = true
                        echo "‚úÖ Email del autor v√°lido: ${commitEmail}"
                    } else {
                        validations['Email v√°lido'] = false
                        validationErrors.add("Email del autor inv√°lido: ${commitEmail}")
                        echo "‚ùå Email del autor inv√°lido"
                    }
                    
                    // Validar que hay mensaje
                    if (commitMessage && commitMessage.length() > 0) {
                        validations['Mensaje presente'] = true
                        echo "‚úÖ Mensaje del commit presente"
                    } else {
                        validations['Mensaje presente'] = false
                        validationErrors.add("Mensaje del commit vac√≠o")
                        echo "‚ùå Mensaje del commit vac√≠o"
                    }
                    
                    // Validar que el repositorio es de Gitea
                    // NOTA: El remoto puede contener el nombre del servicio o del contenedor
                    if (remoteUrl && (remoteUrl.contains(env.GITEA_SERVICE) || remoteUrl.contains(env.GITEA_CONTAINER))) {
                        validations['Repositorio Gitea'] = true
                        echo "‚úÖ Repositorio es de Gitea: ${remoteUrl}"
                    } else {
                        validations['Repositorio Gitea'] = false
                        validationErrors.add("Repositorio no es de Gitea: ${remoteUrl}")
                        echo "‚ùå Repositorio no es de Gitea"
                    }
                    
                    // Validar que estamos usando el plugin de Gitea (usando variables de entorno del stage anterior)
                    def pluginInstalled = env.GITEA_PLUGIN_INSTALLED == 'true'
                    def pluginConfigured = env.GITEA_PLUGIN_CONFIGURED == 'true'
                    def webhooksEnabled = env.GITEA_WEBHOOKS_ENABLED == 'true'
                    
                    if (pluginConfigured) {
                        validations['Plugin Gitea configurado'] = true
                        echo "‚úÖ Plugin de Gitea configurado correctamente"
                        if (webhooksEnabled) {
                            validations['Webhooks habilitados'] = true
                            echo "‚úÖ Webhooks autom√°ticos habilitados - Los eventos de Gitea activar√°n el pipeline"
                        } else {
                            validations['Webhooks habilitados'] = false
                            echo "‚ö†Ô∏è  Webhooks autom√°ticos deshabilitados - Los eventos de Gitea NO activar√°n el pipeline autom√°ticamente"
                            validationErrors.add("Webhooks autom√°ticos deshabilitados - Habilita 'Gestionar Webhooks' en la configuraci√≥n del plugin")
                        }
                    } else {
                        validations['Plugin Gitea configurado'] = false
                        validations['Webhooks habilitados'] = false
                        validationErrors.add("Plugin de Gitea no configurado - Configura el servidor Gitea en Jenkins")
                        echo "‚ùå Plugin de Gitea no configurado"
                    }
                    
                    // Verificar tambi√©n que el plugin est√° instalado
                    if (pluginInstalled) {
                        validations['Plugin Gitea instalado'] = true
                        echo "‚úÖ Plugin de Gitea instalado"
                    } else {
                        validations['Plugin Gitea instalado'] = false
                        validationErrors.add("Plugin de Gitea no instalado")
                        echo "‚ùå Plugin de Gitea no instalado"
                    }
                    
                    echo ""
                    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                    echo "üìä RESUMEN DE VALIDACIONES"
                    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                    echo ""
                    
                    def allValid = validations.values().every { it == true }
                    def successCount = validations.values().count { it == true }
                    
                    echo "‚úÖ Validaciones exitosas: ${successCount}/${validations.size()}"
                    echo ""
                    
                    // Mostrar informaci√≥n sobre el uso del plugin
                    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                    echo "üîå ESTADO DE INTEGRACI√ìN CON PLUGIN DE GITEA"
                    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                    echo ""
                    
                    if (pluginConfigured) {
                        echo "‚úÖ Plugin de Gitea est√° configurado y disponible"
                        echo "   - Plugin instalado: ${pluginInstalled ? '‚úÖ' : '‚ùå'}"
                        echo "   - Servidor Gitea configurado: ‚úÖ"
                        echo "   - Webhooks autom√°ticos: ${webhooksEnabled ? '‚úÖ Habilitado' : '‚ö†Ô∏è  Deshabilitado'}"
                        echo "   - Checkout usando credenciales del plugin: ‚úÖ"
                        echo "   - Repositorio remoto apunta a Gitea: ‚úÖ"
                        echo ""
                        if (webhooksEnabled) {
                            echo "‚úÖ El plugin de Gitea gestionar√° webhooks autom√°ticamente"
                            echo "   - Los eventos de Gitea (push, PR, etc.) activar√°n el pipeline"
                            echo "   - Las notificaciones se enviar√°n a Gitea al finalizar builds"
                        } else {
                            echo "‚ö†Ô∏è  Webhooks autom√°ticos deshabilitados"
                            echo "   - Los eventos de Gitea NO activar√°n el pipeline autom√°ticamente"
                            echo "   - Habilita 'Gestionar Webhooks' en la configuraci√≥n del plugin"
                        }
                        echo ""
                        echo "‚ÑπÔ∏è  NOTA: Para pipelines declarativos simples, el plugin de Gitea"
                        echo "   usa GitSCM internamente pero con integraci√≥n espec√≠fica:"
                        echo "   - Gesti√≥n autom√°tica de webhooks (si est√° habilitado)"
                        echo "   - Notificaciones a Gitea al finalizar builds"
                        echo "   - Validaci√≥n de credenciales contra servidor Gitea"
                        echo ""
                        echo "üí° Para usar funcionalidades completas del plugin, considera"
                        echo "   convertir a un Multibranch Pipeline con GiteaSCMSource"
                    } else {
                        echo "‚ö†Ô∏è  El plugin de Gitea no est√° completamente configurado"
                        echo "   - Plugin instalado: ${pluginInstalled ? '‚úÖ' : '‚ùå'}"
                        echo "   - Servidor Gitea configurado: ‚ùå"
                        echo "   - Se est√° usando GitSCM gen√©rico"
                        echo "   - La conexi√≥n es directa a Gitea sin usar el plugin"
                        echo ""
                        echo "üí° Para usar el plugin de Gitea completamente:"
                        echo "   1. Configura el servidor Gitea en Jenkins (Manage Jenkins > Configure System)"
                        echo "   2. Habilita 'Gestionar Webhooks' para integraci√≥n autom√°tica"
                        echo "   3. Considera usar un Multibranch Pipeline con GiteaSCMSource"
                    }
                    echo ""
                    
                    if (allValid) {
                        echo "‚úÖ Todas las validaciones pasaron correctamente"
                        echo ""
                        echo "üéâ La integraci√≥n Jenkins-Gitea est√° funcionando correctamente"
                        echo "   - Plugin de Gitea: ${pluginConfigured ? (webhooksEnabled ? '‚úÖ Configurado con webhooks' : '‚úÖ Configurado (webhooks deshabilitados)') : '‚ö†Ô∏è  No configurado'}"
                        echo "   - Checkout del repositorio: ‚úÖ"
                        echo "   - Informaci√≥n del commit: ‚úÖ"
                    } else {
                        echo "‚ùå Algunas validaciones fallaron:"
                        validationErrors.each { error ->
                            echo "   - ${error}"
                        }
                        // No fallar el pipeline si solo faltan webhooks, solo advertir
                        def criticalErrors = validationErrors.findAll { !it.contains('Webhooks') && !it.contains('webhooks') }
                        if (criticalErrors.size() > 0) {
                            error("Validaci√≥n del commit fall√≥: ${criticalErrors.size()} error(es) cr√≠tico(s)")
                        } else {
                            echo "‚ö†Ô∏è  Advertencias no cr√≠ticas detectadas (webhooks deshabilitados)"
                        }
                    }
                    echo ""
                }
            }
        }
    }
    
    post {
        success {
            script {
                echo ""
                echo "‚úÖ Pipeline completado exitosamente"
                
                // Intentar enviar notificaci√≥n a Gitea usando el plugin
                try {
                    def giteaNotifierClass = 'org.jenkinsci.plugin.gitea.GiteaNotifier'
                    Class.forName(giteaNotifierClass)
                    
                    echo ""
                    echo "üîî Enviando notificaci√≥n a Gitea usando el plugin..."
                    
                    // Obtener informaci√≥n del commit para la notificaci√≥n
                    def commitHash = sh(
                        script: 'git rev-parse --short HEAD 2>/dev/null || echo "unknown"',
                        returnStdout: true
                    ).trim()
                    
                    def commitMessage = sh(
                        script: 'git log -1 --pretty=format:"%s" 2>/dev/null || echo "No commit message"',
                        returnStdout: true
                    ).trim()
                    
                    // El plugin de Gitea enviar√° autom√°ticamente la notificaci√≥n
                    // si est√° configurado correctamente en el job
                    echo "   ‚úÖ Notificaci√≥n configurada para commit: ${commitHash}"
                    echo "   üìù Mensaje: ${commitMessage}"
                } catch (ClassNotFoundException e) {
                    echo ""
                    echo "‚ö†Ô∏è  Plugin de Gitea no disponible para notificaciones"
                    echo "   Las notificaciones se enviar√°n manualmente si es necesario"
                } catch (Exception e) {
                    echo ""
                    echo "‚ö†Ô∏è  Error al enviar notificaci√≥n: ${e.getMessage()}"
                }
            }
        }
        failure {
            script {
                echo ""
                echo "‚ùå Pipeline fall√≥ - Revisa los logs anteriores"
                
                // Intentar enviar notificaci√≥n de fallo a Gitea
                try {
                    def giteaNotifierClass = 'org.jenkinsci.plugin.gitea.GiteaNotifier'
                    Class.forName(giteaNotifierClass)
                    
                    echo ""
                    echo "üîî Enviando notificaci√≥n de fallo a Gitea..."
                    echo "   ‚ö†Ô∏è  El build fall√≥ - Revisa los logs en Jenkins"
                } catch (Exception e) {
                    // Silenciar errores de notificaci√≥n
                }
            }
        }
        always {
            script {
                def timestamp = sh(script: "date '+%Y-%m-%d %H:%M:%S'", returnStdout: true).trim()
                echo ""
                echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                echo "üìù RESUMEN FINAL"
                echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                echo ""
                echo "‚è∞ Completado: ${timestamp}"
                echo "üîó Integraci√≥n Jenkins-Gitea verificada"
                echo ""
                
                // Mostrar estado final del plugin de Gitea
                def pluginInstalled = env.GITEA_PLUGIN_INSTALLED == 'true'
                def pluginConfigured = env.GITEA_PLUGIN_CONFIGURED == 'true'
                def webhooksEnabled = env.GITEA_WEBHOOKS_ENABLED == 'true'
                
                echo "üîå Estado del Plugin de Gitea:"
                if (pluginConfigured) {
                    echo "   ‚úÖ Plugin configurado y disponible"
                    echo "   - Plugin instalado: ${pluginInstalled ? '‚úÖ' : '‚ùå'}"
                    echo "   - Servidor Gitea configurado: ‚úÖ"
                    echo "   - Webhooks autom√°ticos: ${webhooksEnabled ? '‚úÖ Habilitado' : '‚ö†Ô∏è  Deshabilitado'}"
                    if (webhooksEnabled) {
                        echo ""
                        echo "   üí° El plugin gestionar√° webhooks autom√°ticamente:"
                        echo "      - Los eventos de Gitea (push, PR, etc.) activar√°n el pipeline"
                        echo "      - Las notificaciones se enviar√°n a Gitea al finalizar builds"
                    } else {
                        echo ""
                        echo "   ‚ö†Ô∏è  Webhooks autom√°ticos deshabilitados"
                        echo "      - Habilita 'Gestionar Webhooks' en la configuraci√≥n del plugin"
                        echo "      - Los eventos de Gitea NO activar√°n el pipeline autom√°ticamente"
                    }
                } else {
                    echo "   ‚ö†Ô∏è  Plugin no configurado completamente"
                    echo "   - Plugin instalado: ${pluginInstalled ? '‚úÖ' : '‚ùå'}"
                    echo "   - Servidor Gitea configurado: ‚ùå"
                    echo "   - Se est√° usando conexi√≥n directa con GitSCM"
                    echo ""
                    echo "   üí° Para habilitar funcionalidades completas:"
                    echo "      1. Configura el servidor Gitea en Jenkins"
                    echo "      2. Habilita 'Gestionar Webhooks' para integraci√≥n autom√°tica"
                }
                echo ""
            }
        }
    }
}
