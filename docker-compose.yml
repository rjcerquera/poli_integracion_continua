version: '3.8'

services:
  # Backend - Laravel API
  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
    container_name: ${LARAVEL_CONTAINER_NAME:-laravel_backend}
    working_dir: /var/www
    environment:
      - APP_ENV=${APP_ENV:-local}
      - APP_DEBUG=${APP_DEBUG:-true}
      - DB_CONNECTION=${DB_CONNECTION:-mysql}
      - DB_HOST=${DB_HOST:-mysql}
      - DB_PORT=${DB_PORT:-3306}
      - DB_DATABASE=${DB_DATABASE:-laravel}
      - DB_USERNAME=${DB_USERNAME:-laravel_user}
      - DB_PASSWORD=${DB_PASSWORD:-laravel_password}
      - RUN_SEEDERS=${RUN_SEEDERS:-false}
    networks:
      - app-network
    depends_on:
      mysql:
        condition: service_healthy

  # Nginx - Web Server
  nginx:
    image: nginx:alpine
    container_name: ${NGINX_CONTAINER_NAME:-laravel_nginx}
    ports:
      - "${NGINX_HTTP_PORT:-8080}:80"
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf
    volumes_from:
      - backend
    networks:
      - app-network
    depends_on:
      - backend

  # MySQL Database
  mysql:
    image: mysql:${MYSQL_VERSION:-8.0}
    container_name: ${MYSQL_CONTAINER_NAME:-laravel_mysql}
    ports:
      - "${MYSQL_PORT:-3306}:3306"
    volumes:
      - mysql-data:/var/lib/mysql
    environment:
      MYSQL_DATABASE: ${MYSQL_DATABASE:-laravel}
      MYSQL_USER: ${MYSQL_USER:-laravel_user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-laravel_password}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root_password}
    networks:
      - app-network
    command: --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-root_password}"]
      interval: 5s
      timeout: 5s
      retries: 10

  # Frontend - Next.js
  frontend:
    build:
      context: .
      dockerfile: frontend/Dockerfile
      network: host
    container_name: ${FRONTEND_CONTAINER_NAME:-nextjs_frontend}
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    environment:
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://localhost:8080/api}
    networks:
      - app-network
    depends_on:
      - backend

  # Jenkins - CI/CD Server con Plugins Pre-instalados
  jenkins:
    build:
      context: ./jenkins
      dockerfile: Dockerfile
      args:
        JENKINS_ADMIN_USER: ${JENKINS_ADMIN_ID:-admin}
        JENKINS_ADMIN_PASSWORD: ${JENKINS_ADMIN_PASSWORD:-admin123}
    container_name: ${JENKINS_CONTAINER_NAME:-jenkins_server}
    ports:
      - "${JENKINS_HTTP_PORT:-8081}:8080"
      - "${JENKINS_AGENT_PORT:-50000}:50000"
    volumes:
      - jenkins-data:/var/jenkins_home
      - /var/run/docker.sock:/var/run/docker.sock
      # Montar Jenkinsfile para que esté disponible en el contenedor
      - ./jenkins/Jenkinsfile:/var/jenkins_home/jenkins-pipeline/Jenkinsfile:ro
    environment:
      - JENKINS_ADMIN_ID=${JENKINS_ADMIN_ID:-admin}
      - JENKINS_ADMIN_PASSWORD=${JENKINS_ADMIN_PASSWORD:-admin123}
      - DOCKER_HOST=unix:///var/run/docker.sock
      - TZ=${TZ:-America/Bogota}
      # Credenciales de Gitea para Jenkins
      - GITEA_USERNAME=${GITEA_USERNAME:-jenkins}
      - GITEA_PASSWORD=${GITEA_PASSWORD:-jenkins123}
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/login || exit 1"]
      interval: 30s
      timeout: 10s
      start_period: 120s
      retries: 5

  # Gitea - Servidor Git Liviano (~200MB RAM)
  gitea:
    image: gitea/gitea:${GITEA_VERSION:-latest}
    container_name: ${GITEA_CONTAINER_NAME:-gitea_server}
    ports:
      - "${GITEA_HTTP_PORT:-3001}:3000"
      - "${GITEA_SSH_PORT:-2223}:22"
    volumes:
      - gitea-data:/data
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    environment:
      - USER_UID=${GITEA_USER_UID:-1000}
      - USER_GID=${GITEA_USER_GID:-1000}
      # Configuración del servidor
      - GITEA__server__DOMAIN=${GITEA_DOMAIN:-localhost}
      - GITEA__server__ROOT_URL=${GITEA_ROOT_URL:-http://localhost:3001}
      - GITEA__server__SSH_PORT=${GITEA_SSH_PORT:-2223}
      # Configuración de base de datos MySQL (auto-instalación)
      # NOTA: No establecer INSTALL_LOCK=true aquí porque Gitea necesita detectar
      #       automáticamente si debe instalarse (BD vacía). Las variables GITEA__admin__*
      #       solo funcionan durante el proceso de instalación inicial.
      # NOTA: Usar el nombre del servicio 'mysql', no el nombre del contenedor
      - GITEA__database__DB_TYPE=mysql
      - GITEA__database__HOST=mysql:${MYSQL_PORT:-3306}
      - GITEA__database__NAME=${GITEA_DB_NAME:-gitea}
      - GITEA__database__USER=${GITEA_DB_USER:-gitea_user}
      - GITEA__database__PASSWD=${GITEA_DB_PASSWORD:-gitea_password}
      # Usuario administrador inicial (auto-creación durante instalación)
      # IMPORTANTE: Estas variables solo funcionan cuando INSTALL_LOCK=false (primera ejecución)
      # Gitea automáticamente establece INSTALL_LOCK=true después de la instalación
      - GITEA__admin__user=${GITEA_ADMIN_USER:-admin}
      - GITEA__admin__email=${GITEA_ADMIN_EMAIL:-admin@example.com}
      - GITEA__admin__password=${GITEA_ADMIN_PASSWORD:-admin123}
      # Configuración de repositorios
      - GITEA__repository__DEFAULT_PRIVATE=${GITEA_DEFAULT_PRIVATE:-true}
      - GITEA__repository__ENABLE_PUSH_CREATE_USER=${GITEA_ENABLE_PUSH_CREATE_USER:-false}
      - GITEA__repository__ENABLE_PUSH_CREATE_ORG=${GITEA_ENABLE_PUSH_CREATE_ORG:-false}
      # Deshabilitar registro público (seguridad)
      - GITEA__service__DISABLE_REGISTRATION=${GITEA_DISABLE_REGISTRATION:-true}
      - GITEA__security__INSTALL_LOCK=true
    networks:
      - app-network
    depends_on:
      mysql:
        condition: service_healthy
    restart: unless-stopped

  # Gitea Bootstrap - Inicialización completa de Gitea
  # Incluye: inicialización de MySQL, creación de usuarios, repositorios y push del código
  gitea-bootstrap:
    build:
      context: ./gitea-bootstrap
      dockerfile: Dockerfile
    container_name: gitea_bootstrap
    volumes:
      - .:/workspace
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      # Variables para MySQL (inicialización de BD)
      # NOTA: Usar el nombre del servicio 'mysql', no el nombre del contenedor
      - MYSQL_HOST=mysql
      - MYSQL_PORT=${MYSQL_PORT:-3306}
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:-root_password}
      - GITEA_DB_NAME=${GITEA_DB_NAME:-gitea}
      - GITEA_DB_USER=${GITEA_DB_USER:-gitea_user}
      - GITEA_DB_PASSWORD=${GITEA_DB_PASSWORD:-gitea_password}
      # Variables para Gitea (configuración de usuarios y repositorios)
      # NOTA: GITEA_HOST debe ser el nombre del SERVICIO (gitea), no el nombre del contenedor
      #       Dentro de la red Docker, los servicios se comunican usando el nombre del servicio
      - GITEA_HOST=gitea
      - GITEA_PORT=3000
      - GITEA_CONTAINER_NAME=${GITEA_CONTAINER_NAME:-gitea_server}
      - GITEA_ADMIN_USER=${GITEA_ADMIN_USER:-admin}
      - GITEA_ADMIN_PASSWORD=${GITEA_ADMIN_PASSWORD:-admin123}
      - GITEA_ADMIN_EMAIL=${GITEA_ADMIN_EMAIL:-admin@example.com}
      - GITEA_DOMAIN=${GITEA_DOMAIN:-localhost}
      - GITEA_ROOT_URL=${GITEA_ROOT_URL:-http://localhost:3001}
      - GITEA_SSH_PORT=${GITEA_SSH_PORT:-2223}
      - GITEA_DISABLE_REGISTRATION=${GITEA_DISABLE_REGISTRATION:-true}
      - GITEA_REPO_OWNER=${GITEA_REPO_OWNER:-}
      - GITEA_REPO_NAME=${GITEA_REPO_NAME:-poli_integracion_continua}
      - GITEA_REPO_PRIVATE=${GITEA_REPO_PRIVATE:-true}
      - GITEA_REPO_DESCRIPTION=${GITEA_REPO_DESCRIPTION:-Proyecto de Integración Continua}
      - GITEA_JENKINS_USER=${GITEA_USERNAME:-jenkins}
      - GITEA_JENKINS_PASSWORD=${GITEA_PASSWORD:-jenkins123}
      - GITEA_JENKINS_EMAIL=${GITEA_EMAIL:-jenkins@example.com}
      - GITEA_AUTO_PUSH=${GITEA_AUTO_PUSH:-true}
      - GITEA_REPO_PATH=/workspace
    networks:
      - app-network
    depends_on:
      mysql:
        condition: service_healthy
    restart: "no"

networks:
  app-network:
    driver: bridge

volumes:
  mysql-data:
  jenkins-data:
  gitea-data:

